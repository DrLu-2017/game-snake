<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>贪吃蛇游戏</title>
  <style>
    body { margin: 0; display: flex; flex-direction: column; align-items: center; background: #111; color: #fff; font-family: sans-serif; }
    canvas { background: #333; margin-top: 20px; }
    .buttons { margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center; }
    .btn { padding: 10px 20px; margin: 5px; background: #333; color: #fff; border: none; font-size: 18px; border-radius: 8px; }
    #currentTimeDisplay { margin-top: 10px; font-size: 16px; }
    #scoreDisplay { margin-top: 5px; font-size: 20px; color: #fff; }
  </style>
</head>
<body>
  <h1>贪吃蛇游戏</h1>
  <div id="currentTimeDisplay"></div>
  <div id="scoreDisplay">Score: 0</div>
  <canvas id="game" width="400" height="400"></canvas>
  <div class="buttons">
    <button class="btn" onclick="setDirection('up')">↑</button>
    <button class="btn" onclick="setDirection('left')">←</button>
    <button class="btn" onclick="setDirection('down')">↓</button>
    <button class="btn" onclick="setDirection('right')">→</button>
    <button id="startGameBtn" class="btn">Start Game</button>
    <button id="playPauseBtn" class="btn">Play/Pause Music</button><span style="font-size: 12px; color: #aaa; margin-left: 5px;">(Music: 'background_music.mp3' needed)</span>
    <button class="btn difficulty-btn" data-level="easy" style="display: none;">Easy</button>
    <button class="btn difficulty-btn" data-level="medium" style="display: none;">Medium</button>
    <button class="btn difficulty-btn" data-level="hard" style="display: none;">Hard</button>
  </div>
  <!-- NOTE: "background_music.mp3" is a placeholder. Replace with a valid audio file path for music to play. -->
  <audio id="bgMusic" src="background_music.mp3" loop></audio>

  <!-- Scripts will be loaded here -->
  <script src="food.js"></script>
  <script src="snake.js"></script>
  <script src="game.js"></script>

  <script>
    // Essential global variables for canvas and game setup
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const box = 20; // Size of each game grid box
    const rows = canvas.width / box; // Number of rows/columns in the grid

    // UI Elements & Event Listeners specific to index.html
    const bgMusic = document.getElementById("bgMusic");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const difficultyButtons = document.querySelectorAll(".difficulty-btn");
    const startGameBtn = document.getElementById("startGameBtn");
    const currentTimeDisplay = document.getElementById("currentTimeDisplay");
    // const scoreDisplay = document.getElementById("scoreDisplay"); // Already created by game.js logic or added HTML

    // Initialize food and draw initial game screen (start message)
    // food.js and game.js functions are now globally available.
    document.addEventListener('DOMContentLoaded', () => {
        // initFood(); // Removed: initFood is no longer in food.js.
                       // generateNewFood() is called by initGame() in game.js.
        drawGame(); // Call from game.js to draw the initial "Press Start Game" screen.
    });


    // Event Listener for Start Game Button
    startGameBtn.addEventListener("click", () => {
      initGame(); // This function is from game.js
      startGameBtn.style.display = 'none';
      difficultyButtons.forEach(btn => btn.style.display = 'inline-block');
    });

    // Event Listener for Keyboard Controls
    document.addEventListener("keydown", e => {
      if (e.key === " ") {
        // Pause logic is now within togglePauseGame in game.js
        togglePauseGame();
        e.preventDefault();
      } else if (gameStarted && !isPaused) {
        // Direction change logic is now within changeDirection in snake.js
        if (e.key === "ArrowUp") { changeDirection('up'); }
        else if (e.key === "ArrowDown") { changeDirection('down'); }
        else if (e.key === "ArrowLeft") { changeDirection('left'); }
        else if (e.key === "ArrowRight") { changeDirection('right'); }
      }
    });

    // Event Listener for Touchscreen Direction Buttons
    // This function is called by onclick attributes in HTML
    function setDirection(direction) {
      if (gameStarted && !isPaused) {
        changeDirection(direction); // from snake.js
      }
    }

    // Event Listeners for Difficulty Buttons
    difficultyButtons.forEach(button => {
      button.addEventListener("click", () => {
        setGameDifficulty(button.dataset.level); // from game.js
      });
    });

    // Music Play/Pause Button
    playPauseBtn.addEventListener("click", () => {
      if (bgMusic.paused) {
        bgMusic.play();
        playPauseBtn.textContent = "Pause Music";
      } else {
        bgMusic.pause();
        playPauseBtn.textContent = "Play Music";
      }
    });

    // Current Time Display
    function updateTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      currentTimeDisplay.innerHTML = `${hours}:${minutes}:${seconds}`;
    }
    updateTime(); // Initial call
    setInterval(updateTime, 1000); // Update every second

    // Swipe Controls for Mobile
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    const minSwipeDistance = 30; // Minimum distance for a swipe to be registered
    let lastTapTime = 0;
    const doubleTapDelay = 300; // Milliseconds
    const tapThreshold = 10; // Max pixels to move for it to be considered a tap

    canvas.addEventListener('touchstart', function(e) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        // Using preventDefault here might interfere with double tap,
        // as it can prevent subsequent touchend in some cases if not handled carefully.
        // Let's manage preventDefault in touchend conditionally.
    }, false);

    canvas.addEventListener('touchmove', function(e) {
        // If significant movement, it's likely a swipe, could preventDefault here
        // For simplicity, handling in touchend based on overall displacement.
    }, false);

    canvas.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].clientX;
        touchEndY = e.changedTouches[0].clientY;

        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;
        const currentTime = new Date().getTime();
        const tapTimeDifference = currentTime - lastTapTime;

        // Check if it's a tap (minimal movement)
        if (Math.abs(diffX) < tapThreshold && Math.abs(diffY) < tapThreshold) {
            e.preventDefault(); // Prevent default actions for taps (like zoom)
            if (tapTimeDifference < doubleTapDelay && tapTimeDifference > 0) {
                // Double tap
                if (gameStarted && !gameOver) {
                    togglePauseGame(); // Pause/resume active game
                } else {
                    // If game not started, or is over, double tap acts like "Start Game"
                    // Need to ensure UI elements like start button are handled correctly by initGame
                    const startGameButton = document.getElementById('startGameBtn');
                    if(startGameButton) startGameButton.style.display = 'none'; // Hide if visible
                    difficultyButtons.forEach(btn => btn.style.display = 'inline-block'); // Show
                    initGame();
                }
                lastTapTime = 0; // Reset lastTapTime to prevent triple tap from acting as double
            } else {
                // Single tap
                lastTapTime = currentTime;
            }
        } else { // Else, it's a swipe
            if (!gameStarted || isPaused) return; // Only process swipes if game is active and not paused

            if (Math.abs(diffX) > Math.abs(diffY)) { // Horizontal swipe
                if (diffX > minSwipeDistance) {
                    changeDirection('right');
                } else if (diffX < -minSwipeDistance) {
                    changeDirection('left');
                }
            } else if (Math.abs(diffY) > Math.abs(diffX)) { // Vertical swipe
                if (diffY > minSwipeDistance) {
                    changeDirection('down');
                } else if (diffY < -minSwipeDistance) {
                    changeDirection('up');
                }
            }
            // Consider adding e.preventDefault() here for swipes if page scrolling is an issue.
        }
    }, false);

  </script>
</body>
</html>
