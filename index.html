<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>贪吃蛇游戏</title>
  <style>
    body { margin: 0; display: flex; flex-direction: column; align-items: center; background: #111; color: #fff; font-family: sans-serif; }
    canvas { background: #333; margin-top: 20px; }
    .buttons { margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center; }
    .btn { padding: 10px 20px; margin: 5px; background: #333; color: #fff; border: none; font-size: 18px; border-radius: 8px; }
    #currentTimeDisplay { margin-top: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>贪吃蛇游戏</h1>
  <div id="currentTimeDisplay"></div>
  <canvas id="game" width="400" height="400"></canvas>
  <div class="buttons">
    <button class="btn" onclick="setDirection('up')">↑</button>
    <button class="btn" onclick="setDirection('left')">←</button>
    <button class="btn" onclick="setDirection('down')">↓</button>
    <button class="btn" onclick="setDirection('right')">→</button>
    <button id="startGameBtn" class="btn">Start Game</button>
    <button id="playPauseBtn" class="btn">Play/Pause Music</button><span style="font-size: 12px; color: #aaa; margin-left: 5px;">(Music: 'background_music.mp3' needed)</span>
    <button class="btn difficulty-btn" data-level="easy" style="display: none;">Easy</button>
    <button class="btn difficulty-btn" data-level="medium" style="display: none;">Medium</button>
    <button class="btn difficulty-btn" data-level="hard" style="display: none;">Hard</button>
  </div>
  <!-- NOTE: "background_music.mp3" is a placeholder. Replace with a valid audio file path for music to play. -->
  <audio id="bgMusic" src="background_music.mp3" loop></audio>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const box = 20;
    const rows = canvas.width / box;
    let snake = [{ x: 10, y: 10 }];
    let food = randomPosition();
    let dx = 1, dy = 0;
    let score = 0;
    let gameOver = false;
    let gameSpeed = 200; // Default to Easy speed
    let gameIntervalId;
    let isPaused = false;
    let gameStarted = false;

    function randomPosition() {
      return {
        x: Math.floor(Math.random() * rows),
        y: Math.floor(Math.random() * rows)
      };
    }

    function draw() {
      if (!gameStarted) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff";
        ctx.font = "30px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Press Start Game", canvas.width / 2, canvas.height / 2);
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 绘制蛇
      for (let s of snake) {
        ctx.fillStyle = "#0f0";
        ctx.fillRect(s.x * box, s.y * box, box - 2, box - 2);
      }

      // 绘制食物
      ctx.fillStyle = "#f00";
      ctx.fillRect(food.x * box, food.y * box, box - 2, box - 2);

      if (isPaused) {
        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff";
        ctx.font = "30px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Paused", canvas.width / 2, canvas.height / 2);
      }
    }

    function update() {
      if (gameOver) return;

      if (isPaused) {
        draw(); // Keep drawing the screen to show "Paused" message and current state
        return;
      }

      const head = { x: snake[0].x + dx, y: snake[0].y + dy };

      // 撞墙
      if (head.x < 0 || head.x >= rows || head.y < 0 || head.y >= rows) {
        endGame();
        return;
      }

      // 撞自己
      for (let s of snake) {
        if (s.x === head.x && s.y === head.y) {
          endGame();
          return;
        }
      }

      snake.unshift(head);

      // 吃到食物
      if (head.x === food.x && head.y === food.y) {
        food = randomPosition();
        score++;
      } else {
        snake.pop();
      }

      draw();
    }

    function endGame() {
      gameOver = true;
      alert("游戏结束！你的得分：" + score);
      location.reload();
    }

    // 控制方向
    document.addEventListener("keydown", e => {
      if (e.key === " ") {
        if (!gameStarted) {
          return; // Do not allow pausing if the game hasn't started
        }
        isPaused = !isPaused;
        e.preventDefault();
        // If pausing, call draw immediately to show the message.
        // If unpausing, the next interval tick will call update then draw.
        if (isPaused) {
            draw();
        }
        return; // Don't process other keys if space was pressed
      }

      if (!isPaused) { // Only allow direction changes if not paused
        if (e.key === "ArrowUp" && dy === 0) { dx = 0; dy = -1; }
        if (e.key === "ArrowDown" && dy === 0) { dx = 0; dy = 1; }
        if (e.key === "ArrowLeft" && dx === 0) { dx = -1; dy = 0; }
        if (e.key === "ArrowRight" && dx === 0) { dx = 1; dy = 0; }
      }
    });

    // 手机触屏按钮
    function setDirection(dir) { // Also ensure touch controls respect pause
      if (isPaused) return;
      if (dir === 'up' && dy === 0) { dx = 0; dy = -1; }
      if (dir === 'down' && dy === 0) { dx = 0; dy = 1; }
      if (dir === 'left' && dx === 0) { dx = -1; dy = 0; }
      if (dir === 'right' && dx === 0) { dx = 1; dy = 0; }
    }

    function setDifficulty(level) {
      switch (level) {
        case 'easy':
          gameSpeed = 200;
          break;
        case 'medium':
          gameSpeed = 150;
          break;
        case 'hard':
          gameSpeed = 100;
          break;
      }
      clearInterval(gameIntervalId);
      // Optional: Reset game state here (snake position, score, etc.)
      // For now, just restarting the interval with new speed
      // Only start/restart interval if game has already started
      if (gameStarted) {
        clearInterval(gameIntervalId); // Clear existing loop
        gameIntervalId = setInterval(update, gameSpeed);
      }
    }

    draw(); // Initial draw (will show "Press Start Game")

    const bgMusic = document.getElementById("bgMusic");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const difficultyButtons = document.querySelectorAll(".difficulty-btn");
    const startGameBtn = document.getElementById("startGameBtn");

    startGameBtn.addEventListener("click", () => {
      gameStarted = true;
      isPaused = false;
      gameOver = false;
      snake = [{ x: 10, y: 10 }];
      dx = 1; dy = 0;
      score = 0;
      food = randomPosition();
      // gameSpeed is already 200 (Easy) or set by difficulty buttons if they were active

      clearInterval(gameIntervalId); // Clear any residual interval
      gameIntervalId = setInterval(update, gameSpeed);

      startGameBtn.style.display = 'none'; // Hide start button
      // Show difficulty buttons
      difficultyButtons.forEach(btn => btn.style.display = 'inline-block');

      draw(); // Draw initial game state
    });

    playPauseBtn.addEventListener("click", () => {
      if (bgMusic.paused) {
        bgMusic.play();
        playPauseBtn.textContent = "Pause Music";
      } else {
        bgMusic.pause();
        playPauseBtn.textContent = "Play Music";
      }
    });

    difficultyButtons.forEach(button => {
      button.addEventListener("click", () => {
        setDifficulty(button.dataset.level);
      });
    });

    const currentTimeDisplay = document.getElementById("currentTimeDisplay");

    function updateTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      currentTimeDisplay.innerHTML = `${hours}:${minutes}:${seconds}`;
    }

    updateTime();
    setInterval(updateTime, 1000);

    // Start game loop - REMOVED, game starts on button click now
    // gameIntervalId = setInterval(update, gameSpeed);
  </script>
</body>
</html>
